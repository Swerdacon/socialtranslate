<html>
  <head>
    <script type="text/javascript" src="http://www.google.com/jsapi">
    </script>
    <script type="text/javascript">

      /* Load the Google Language Translation API. */
      google.load("language", "1");

      function initialize() {
        /* Initialize preferences. */
        if (!localStorage['primary_language']) {
          var languageCode = window.navigator.language.slice(0, 2);
          for (var key in google.language.Languages) {
            if (google.language.Languages[key] == languageCode) {
              localStorage['primary_language'] = key;
              console.log('Setting primary language to ' + key);
              break;
            }
          }
        }

        if (!localStorage['secondary_languages']) {
          // Secondary languages are empty by default.
          localStorage['secondary_languages'] = JSON.stringify([]);
        }

        /* Setup the content script -> background page API. */
        chrome.extension.onRequest.addListener(
            function(request, sender, sendResponse) {
              if (request.action == "translate") {
                /* This could happen if we weren't able to auto detect the
                 * user's primary language. In this case, we just return the
                 * untranslated text.
                 */
                if (!localStorage['primary_language']) {
                  console.log('No primary language, not translating.');
                  sendResponse({translation: request.msg});
                  return;
                }
                google.language.translate(
                  request.msg, "",
                  google.language.Languages[localStorage['primary_language']],
                  function(result) {
                    if (!result.error && result.detectedSourceLanguage &&
                      result.detectedSourceLanguage !=
                      localStorage['primary_language']) {
                      var secondaryLanguages = JSON.parse(
                        localStorage['secondary_languages']);
                      for (var i = 0; i < secondaryLanguages.length; i++) {
                        var language = secondaryLanguages[i];
                        if (result.detectedSourceLanguage ==
                          google.language.Languages[language]) {
                          console.log("One of secondary languages");
                          sendResponse({translation: request.msg});
                          return;
                        }
                      }
                      sendResponse(result);
                    }
                    sendResponse({translation: request.msg});
                  });
              } else if (request.action == "languages") {
                console.log("Request for languages.");
                sendResponse({languages: google.language.Languages});
              } else {
                console.log("Invalid action given.");
              }
            });
      }

      google.setOnLoadCallback(initialize);

    </script>
  </head>
</html>
